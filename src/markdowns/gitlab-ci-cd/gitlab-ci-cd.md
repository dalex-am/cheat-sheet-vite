### **1. Общая структура**

- **Образ (image)**: `node:lts-alpine` – используется облегченный образ Node.js на Alpine Linux.
- **Этапы (stages)**:
  - `validating` – проверка кода (линтеры, тесты).
  - `deploy` – сборка и деплой.
- **Глобальные переменные**:
  - `GIT_SUBMODULE_STRATEGY: recursive` – подтягивает подмодули Git рекурсивно.
  - `CI: "true"` – явное указание, что скрипт выполняется в CI-среде.

---

### **2. Шаблоны (Templates)**

#### `.deploy_template`

- **Назначение**: Базовый шаблон для задач деплоя.
- **Действия**:
  - Устанавливает NPM-токен для приватного репозитория (`npm.corp.infomaximum.com`).
  - Ставит `git` через `apk` (нужен для работы с подмодулями).
  - Устанавливает зависимости через `yarn` строго по `yarn.lock` (`--frozen-lockfile`).
  - Собирает проект (`yarn build`).
- **Артефакты**:
  - Сохраняет папку `_release` с именем в формате: `<ветка>-<хэш коммита>-<имя задачи>`.
  - Артефакты удаляются через 2 часа (`expire_in: 2h`).
- **Зависимости**: Запускается только после успешного выполнения задач `linting` и `tests` (`needs`).
- **Ресурсная группа**: `deploy` – гарантирует, что только один экземпляр задачи выполняется одновременно.

#### `.release_template`

- **Наследует** `.deploy_template`, но меняет срок хранения артефактов на **36 месяцев** (для релизных версий).

---

### **3. Кэширование (Cache)**

- **Ключ кэша**: Зависит от изменения `yarn.lock` – если файл изменился, кэш пересоздается.
- **Кэшируемые пути**:
  - `node_modules/` – основные зависимости.
  - `packages/*/node_modules` – зависимости для монорепозитория (если используется, например, Lerna/Yarn Workspaces).
  - `libs/*/node_modules` – зависимости для локальных библиотек.

---

### **4. Этап Validating**

#### Задача `linting`

- **Цель**: Проверка кода линтером.
- **Действия**:
  - Установка NPM-токена и зависимостей.
  - Запуск линтера (`yarn lint:ci`).
- **Ресурсная группа**: `linting` – контроль параллельного выполнения.

#### Задача `tests`

- **Цель**: Запуск тестов.
- **Действия**:
  - Аналогичная установка зависимостей.
  - Запуск тестов (`yarn test:ci`).
- **Ресурсная группа**: `tests`.

---

### **5. Этап Deploy**

#### Задача `release_branch`

- **Наследует** `.deploy_template`.
- **Условие**: Запускается для **всех веток** (`only: branches`).
- **Итог**: Собирает артефакты с коротким сроком хранения (2 часа).

#### Задача `release`

- **Наследует** `.release_template`.
- **Условие**: Запускается только для **тегов** (`only: tags`).
- **Итог**: Собирает артефакты с долгим сроком хранения (36 месяцев) – для продакшн-релизов.

---

### **6. Важные особенности**

1. **Приватные зависимости**: Используется `NPM_TOKEN` для доступа к корпоративному NPM-репозиторию (передается через переменные GitLab).
2. **Монорепозиторий**: Структура кэша (`packages/*/node_modules`) намекает на использование монорепозитория (например, Yarn Workspaces).
3. **Безопасность**:
   - Токены и секреты не хардкодятся, а передаются через переменные CI.
   - `--frozen-lockfile` предотвращает случайное изменение `yarn.lock`.
4. **Оптимизация**:
   - Кэширование `node_modules` ускоряет выполнение.
   - `resource_group` избегает конфликтов при параллельном деплое.

---

### **7. Как это работает?**

1. Пуш в ветку → запускаются `linting` и `tests`.
2. Если проверки прошли → создается артефакт в `release_branch` (на 2 часа).
3. Создание тега (например, `v1.0.0`) → запускается `release` с долгосрочным артефактом.
